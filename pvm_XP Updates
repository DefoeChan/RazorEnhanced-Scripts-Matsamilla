# XP tracker by SilentNox, imporoved by MatsaMilla
#
# Tracks XP of talisman, or meta pet, just start it up 
# and leave talisman / meta stone gump open
#
# Displays XP gained every 10 seconds, total every 60s & grand total


# True = will track XP only since running the script
# False = will track XP since Enhanced, if you stop/restart script it will still track starting xp
trackOnScript = False

    
minxp = 0
currentxp = 0
counter = 0

def setup():
    global startingxp
    global temp
    global currentxp
    
    temp = Gumps.LastGumpGetLine(gumpLine)
    temp = temp.split("/", 1)[0]
    
    if hasInt(temp):
        currentxp = int(temp)
    else:
        setup()
        
    if trackOnScript:
        startingxp = currentxp
        Misc.SendMessage('Starting XP: ' + startingxp, 33)
    else:
        if Misc.CheckSharedValue( pname + 'xp' ):
            startingxp = Misc.ReadSharedValue( pname + 'xp' )
            Misc.SendMessage('Starting XP: ' + str(startingxp) , 33)
            Misc.Pause(200)
            gainedXP = currentxp - startingxp
            if gainedXP > 0:
                Player.HeadMessage(66,'XP since run: ' + str(gainedXP))
            elif gainedXP == 0:
                Misc.NoOperation()
            else:
                Player.HeadMessage(44, 'You leveled up!' )
                Player.ChatSay(66, '[e woohoo')
                Misc.RemoveSharedValue( pname + 'xp' )
                setup() 
        else:
            startingxp = currentxp
            Misc.SetSharedValue( pname + 'xp', startingxp )
            Misc.SendMessage('Starting XP: ' + str(startingxp) , 33)


def hasInt(s):
    try: 
        int(s)
        return True
    except ValueError:
        return False
        
def talismanXp():
    global counter
    global currentxp
    global minxp
    
    if Gumps.CurrentGump() == gumpid: 
        Misc.Pause(10000)
        temp = Gumps.LastGumpGetLine(gumpLine)
        temp = temp.split("/", 1)[0]
        if hasInt(temp):
            newxp = int(temp)
        else:
            newxp = currentxp
        
        difference = newxp - currentxp
        Misc.Pause(120)
        if difference > 0:
            Player.HeadMessage(54, '+' + str(difference) + ' xp')
            currentxp = newxp
        elif difference == 0:
                Misc.NoOperation()
        else:
            Player.HeadMessage(44, 'You leveled up!' )
            Player.ChatSay(66, '[e woohoo')
            Misc.RemoveSharedValue( pname + 'xp' )
            setup() 
        
        minxp = difference + minxp 
        counter = counter + 1
        if counter >= 6:
            overallxp = currentxp - startingxp
            if minxp > 0:
                Player.HeadMessage(54, '+' + str(minxp) + ' xp last 60s')
                Misc.Pause(200)
            
            if overallxp > 0:
                Player.HeadMessage(44, str(overallxp) + 'xp total.')
            elif overallxp == 0:
                Misc.NoOperation()
            else:
                Player.HeadMessage(44, 'You leveled up!' )
                Player.ChatSay(66, '[e woohoo')
                Misc.RemoveSharedValue( pname + 'xp' )
                setup() 
            counter = 0
            minxp = 0
    else:
        tempGump = Gumps.CurrentGump()
        Gumps.CloseGump(tempGump)
    Misc.Pause(50)

Misc.Pause(200)
pname = Player.Name.lower().replace(' ', '')
    
Talli = Player.GetItemOnLayer('Talisman')
if Talli:
    Tallyserial = Items.FindBySerial(Talli.Serial)
    gumpLine = 4
    gumpid = 463091633
else:
    Talli = Items.FindByID( 0x3679  , -1 , Player.Backpack.Serial)
    if Talli:
        Tallyserial = Items.FindBySerial(Talli.Serial)
        gumpLine = 5
        gumpid = 3527528070
    else:
        Misc.SendMessage('Talisman Not Found, Stopping', 33)
        Stop

Items.UseItem(Tallyserial)
Misc.Pause(200)
setup()
while True:
    talismanXp()
